/* 2018-1-15 08:02:02 | 版权所有 合肥火星科技有限公司 http://www.marsgis.cn  【联系我们QQ：516584683】 */
var addmarkerWidget=mars3d.widget.bindClass(mars3d.BaseWidget.extend({viewer:null,options:{resources:["map.css"],view:{type:"window",url:"view.html",windowOptions:{width:300,height:400}}},drawControl:null,markers:[],label_font_style:"",create:function(){var t=this;this.label_font_style="normal small-caps normal 18px 黑体",this.drawControl=new mars3d.Draw({viewer:this.viewer,hasEdit:!0,onStopDrawing:function(r){t.bindMarkerEx(r)}})},viewWindow:null,winCreateOK:function(t,r){this.viewWindow=r},activate:function(){this.hasEdit(!0)},disable:function(){this.stopDraw(),this.hasEdit(!1)},stopDraw:function(){this.drawControl.stopDraw()},drawPoint:function(){this.stopDraw(),this.drawControl.startDraw({type:"billboard",style:{scale:.6,image:this.path+"img/marker.png"}})},editable:!0,hasEdit:function(t){this.editable=t,this.updateMarkerInhtml()},index:0,bindMarkerEx:function(t){null!=t&&null!=t.position&&(t.popup={html:this.getMarkerInhtml(t.attribute.attr),anchor:[0,-25]},t.label=this.getLabelStyle(t.attribute.attr.name),mars3d.popup.show(t,t.position._value),this.markers.push(t))},saveEditFeature:function(t){for(var r,e=0;e<this.markers.length;e++)if(this.markers[e].attribute.attr.id==t){r=this.markers[e],r.attribute.attr.name=$.trim($("#addmarker_attr_name").val()),r.attribute.attr.remark=$.trim($("#addmarker_attr_remark").val()),""==r.attribute.attr.name&&(r.attribute.attr.name="我的标记");break}r.label.text=r.attribute.attr.name,r.popup.html=this.getMarkerInhtml(r.attribute.attr),mars3d.popup.hide(),this.viewWindow.refMarkerList()},deleteEditFeature:function(t){for(var r,e=0;e<this.markers.length;e++)if(this.markers[e].attribute.attr.id==t){r=this.markers[e],this.markers.remove(r);break}r&&this.viewer.entities.remove(r),mars3d.popup.hide(),this.viewWindow.refMarkerList()},getMarkerDataList:function(){for(var t=[],r=0;r<this.markers.length;r++){var e=this.markers[r];t.push(e.attribute.attr)}return t},updateMarkerInhtml:function(){for(var t=0;t<this.markers.length;t++)this.markers[t].popup.html=this.getMarkerInhtml(this.markers[t].attribute.attr)},getMarkerInhtml:function(t){var r;return this.editable?(t.name||(t.name=""),t.remark||(t.remark=""),t.id||(t.id=this.index++),r='<div class="addmarker-popup-titile">添加标记</div><div class="addmarker-popup-content" ><form ><div class="form-group">  <label for="addmarker_attr_name">名称</label><input type="text" id="addmarker_attr_name" class="form-control" value="'+t.name+'" placeholder="请输入标记名称"    /> </div><div class="form-group">  <label for="addmarker_attr_remark">备注</label><textarea id="addmarker_attr_remark" class="form-control" rows="3" style="resize: none;" placeholder="请输入备注（可选填）"   >'+t.remark+'</textarea></div><div class="form-group" style="text-align: center;"><input type="button" class="btn btn-primary  btn-sm" value="保存" onclick="addmarkerWidget.saveEditFeature('+t.id+')" />&nbsp;&nbsp;<input type="button" class="btn btn-danger  btn-sm" value="删除" onclick="addmarkerWidget.deleteEditFeature('+t.id+')" /></div></form></div>'):r='<div class="addmarker-popup-titile">我的标记</div><div class="addmarker-popup-content" ><form ><div class="form-group"><label>名称</label>：'+t.name+'</div><div class="form-group"><label>备注</label>：'+t.remark+"</div></form></div>",r},centerAt:function(t){for(var r,e=0;e<this.markers.length;e++)this.markers[e].attribute.attr.id==t&&(r=this.markers[e]);r&&this.viewer.flyTo(r,{duration:2})},deleteAll:function(){for(var t=0;t<this.markers.length;t++)this.viewer.entities.remove(this.markers[t]);this.markers=[],this.index=0,this.viewWindow.refMarkerList()},getJsonData:function(){for(var t=[],r=0;r<this.markers.length;r++){var e=this.markers[r].attribute.attr,a=this.markers[r].position._value,i=mars3d.drawing.utils.getCoordinates([a]),s={id:e.id,name:e.name,remark:e.remark,x:i[0][0],y:i[0][1],z:i[0][2]};t.push(s)}return JSON.stringify(t)},jsonToLayer:function(t,r){var e=JSON.parse(t);if(null!=e&&0!=e.length){r&&this.deleteAll();var a={type:"billboard",style:{scale:.6,image:this.path+"img/marker.png"}};this.markers=this.drawControl.markersInfoToEntity(t,a,r);for(var i=0;i<this.markers.length;i++){var s=this.markers[i];s.popup={html:this.getMarkerInhtml(s.attribute.attr),anchor:[0,-25]},s.label=this.getLabelStyle(s.attribute.attr.name)}this.viewer.flyTo(this.markers,{duration:2}),this.viewWindow.refMarkerList()}},getLabelStyle:function(t){return new Cesium.LabelGraphics({text:""==t?"我的标记":t,font:this.label_font_style,style:Cesium.LabelStyle.FILL_AND_OUTLINE,outlineColor:Cesium.Color.BLACK,outlineWidth:3,horizontalOrigin:Cesium.HorizontalOrigin.LEFT,pixelOffset:new Cesium.Cartesian2(10,(-40))})}}));