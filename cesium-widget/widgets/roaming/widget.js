/* 2018-1-5 14:30:22 | 版权所有 合肥火星科技有限公司 http://www.marsgis.cn  【联系我们QQ：516584683】 */
mars3d.widget.bindClass(mars3d.BaseWidget.extend({options:{view:{type:"window",url:"view.html",windowOptions:{width:350,height:300}}},pathStyle:{color:"#FFFF00",width:3},drawControl:null,create:function(){var t=this;this.drawControl=new mars3d.Draw({viewer:this.viewer,hasEdit:!1,onStopDrawing:function(i){t.pathEntity=i,t.updateEntityHeight(t.flyHeight)}})},viewWindow:null,winCreateOK:function(t,i){this.viewWindow=i},activate:function(){},disable:function(){this.stop(),this.clearLine()},pathEntity:null,clearLine:function(){this.pathEntity&&this.viewer.entities.remove(this.pathEntity),this.pathEntity=null},drawLine:function(t){this.flyHeight=t,this.clearLine(),this.drawControl.startDraw({type:"polyline",style:this.pathStyle})},existFlyPath:function(){return!(!this.property&&!this.pathEntity)||(haoutil.msg("请先在地图上设定漫游路线！"),!1)},getLineCoordinates:function(){if(null==this.pathEntity)return haoutil.msg("请先在地图上设定漫游路线！"),null;var t=mars3d.drawing.utils.getCoordinates(this.pathEntity.perPositions);return t},updateSpeed:function(t){this.viewer.clock.multiplier=t||1},isFollowModel:!0,followedX:null,followedZ:null,updateIsFollowModel:function(t){this.isFollowModel=t},updateFollowX:function(t){this.followedX=t},updateFollowZ:function(t){this.followedZ=t},flyHeight:0,updateEntityHeight:function(t){if(this.flyHeight=t,null!=this.pathEntity){if(null==this.pathEntity.perPositions){for(var i=[],e=this.drawControl.getPositions(this.pathEntity),n=0;n<e.length;n++){var s=e[n].clone();i.push(s)}this.pathEntity.perPositions=i}var o=this.pathEntity.perPositions,r=mars3d.drawing.utils.getPositionsWithHeight(o,this.flyHeight);this.drawControl.setPositions(this.pathEntity,r)}},property:null,startTime:0,stopTime:0,updateTime:function(t){this.property=new Cesium.SampledPositionProperty,this.startTime=Cesium.JulianDate.fromDate(new Date),this.stopTime=Cesium.JulianDate.addSeconds(this.startTime,t,new Cesium.JulianDate);for(var i=this.drawControl.getPositions(this.pathEntity),e=0,n=0,s=i.length-1;n<s;n++)e+=Cesium.Cartesian3.distance(i[n],i[n+1]);for(var o=0,n=0;n<i.length;n++){var r=0;0!=n&&(o+=Cesium.Cartesian3.distance(i[n],i[n-1]),r=t*o/e);var a=Cesium.JulianDate.addSeconds(this.startTime,r,new Cesium.JulianDate);this.property.addSample(a,i[n])}},setCurrentTime:function(t){this.viewer.clock.currentTime=Cesium.JulianDate.addSeconds(this.startTime,t,new Cesium.JulianDate)},isStart:!1,flightEntity:null,start:function(t){function i(t,i,e){var r=Cesium.Property.getValueOrUndefined(t.position,i,s);if(Cesium.defined(r)){var a=Cesium.Property.getValueOrUndefined(t.orientation,i,o);return e=Cesium.defined(a)?Cesium.Matrix4.fromRotationTranslation(Cesium.Matrix3.fromQuaternion(a,n),r,e):Cesium.Transforms.eastNorthUpToFixedFrame(r,void 0,e)}}if(t.path){var e=this.drawControl.jsonToEntity({type:"FeatureCollection",features:[{type:"Feature",properties:{name:"线",type:"polyline",style:this.pathStyle},geometry:{type:"LineString",coordinates:t.path}}]},!0);this.pathEntity=e[0],this.flyHeight=t.height,this.updateEntityHeight(this.flyHeight)}if(this.existFlyPath()){this.isStart&&this.stop(),this.isStart=!0,this.pathEntity.polyline.material.color._value.alpha=0,this.isFollowModel=t.isFollowed,this.followedX=t.followedX,this.followedZ=t.followedZ,this.updateTime(t.times),this.viewer.clock.startTime=this.startTime.clone(),this.viewer.clock.stopTime=this.stopTime.clone(),this.viewer.clock.currentTime=this.startTime.clone(),this.viewer.clock.clockRange=Cesium.ClockRange.LOOP_STOP,this.viewer.clock.multiplier=t.speed,this.flightEntity=this.viewer.entities.add({availability:new Cesium.TimeIntervalCollection([new Cesium.TimeInterval({start:this.startTime,stop:this.stopTime})]),position:this.property,orientation:new Cesium.VelocityOrientationProperty(this.property),point:{color:new Cesium.Color.fromCssColorString(this.pathStyle.color).withAlpha(.1),pixelSize:1}}),this.flightEntity.position.setInterpolationOptions({interpolationDegree:3,interpolationAlgorithm:Cesium.HermitePolynomialApproximation}),this.viewer.trackedEntity=this.flightEntity;var n=new Cesium.Matrix3,s=new Cesium.Cartesian3,o=new Cesium.Quaternion,r=new Cesium.Matrix4,a=this;this.viewer.scene.preRender.addEventListener(function(t){if(a.isStart){var e=a.viewer.clock.currentTime.secondsOfDay-a.viewer.clock.startTime.secondsOfDay;if(a.viewWindow.updateRange(e),a.viewer.trackedEntity&&a.isFollowModel){i(a.viewer.trackedEntity,a.viewer.clock.currentTime,r);var n=a.followedX||50,s=a.followedZ||10;a.viewer.scene.camera.lookAtTransform(r,new Cesium.Cartesian3((-n),0,s))}}})}},stop:function(){this.isStart=!1,this.flightEntity&&(this.viewer.entities.remove(this.flightEntity),this.flightEntity=null),this.pathEntity&&(this.pathEntity.polyline.material.color._value.alpha=1),this.viewer.trackedEntity=null}}));